<form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="user-form">
  <div class="dialog-header">
    <h2 mat-dialog-title class="text-2xl font-bold mb-2">{{ data.title }}</h2>
    <p class="text-gray-600 mb-4">
      {{ isEditMode ? 'Modifica la información del usuario' : 'Complete los datos del nuevo usuario' }}
    </p>
  </div>

  <div mat-dialog-content class="dialog-content">
    <!-- Avatar Section -->
    <div class="avatar-section mb-6">
      <div class="flex items-center space-x-4">
        <div class="avatar-preview">
          <img 
            *ngIf="userForm.get('avatar')?.value && isValidImageUrl(userForm.get('avatar')?.value)"
            [src]="userForm.get('avatar')?.value"
            alt="Preview"
            class="avatar-image"
            (error)="onAvatarError()">
          <div 
            *ngIf="!userForm.get('avatar')?.value || !isValidImageUrl(userForm.get('avatar')?.value)"
            class="avatar-placeholder">
            <mat-icon>person</mat-icon>
          </div>
        </div>
        <div class="flex-1">
          <mat-form-field appearance="outline" class="w-full">
            <mat-label>URL del Avatar (opcional)</mat-label>
            <input 
              matInput 
              formControlName="avatar" 
              placeholder="https://ejemplo.com/avatar.jpg">
            <mat-icon matPrefix>image</mat-icon>
            <mat-error>{{ getFieldError('avatar') }}</mat-error>
          </mat-form-field>
        </div>
      </div>
    </div>

    <!-- Personal Information -->
    <div class="section mb-6">
      <h3 class="section-title">Información Personal</h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Email -->
        <mat-form-field appearance="outline">
          <mat-label>Email *</mat-label>
          <input 
            matInput 
            formControlName="email" 
            type="email"
            placeholder="usuario@ejemplo.com">
          <mat-icon matPrefix>email</mat-icon>
          <mat-hint *ngIf="isEditMode">El email no se puede modificar</mat-hint>
          <mat-error>{{ getFieldError('email') }}</mat-error>
        </mat-form-field>

        <!-- Display Name -->
        <mat-form-field appearance="outline">
          <mat-label>Nombre para mostrar</mat-label>
          <input 
            matInput 
            formControlName="displayName" 
            placeholder="Nombre público">
          <mat-icon matPrefix>badge</mat-icon>
          <button 
            matSuffix 
            mat-icon-button 
            type="button"
            (click)="generateDisplayName()"
            matTooltip="Generar desde nombre y apellido">
            <mat-icon>auto_awesome</mat-icon>
          </button>
          <mat-error>{{ getFieldError('displayName') }}</mat-error>
        </mat-form-field>

        <!-- First Name -->
        <mat-form-field appearance="outline">
          <mat-label>Nombre *</mat-label>
          <input 
            matInput 
            formControlName="firstName" 
            placeholder="Nombre">
          <mat-icon matPrefix>person</mat-icon>
          <mat-error>{{ getFieldError('firstName') }}</mat-error>
        </mat-form-field>

        <!-- Last Name -->
        <mat-form-field appearance="outline">
          <mat-label>Apellido *</mat-label>
          <input 
            matInput 
            formControlName="lastName" 
            placeholder="Apellido">
          <mat-icon matPrefix>person</mat-icon>
          <mat-error>{{ getFieldError('lastName') }}</mat-error>
        </mat-form-field>

        <!-- Phone -->
        <mat-form-field appearance="outline">
          <mat-label>Teléfono</mat-label>
          <input 
            matInput 
            formControlName="phone" 
            placeholder="+1 (555) 123-4567">
          <mat-icon matPrefix>phone</mat-icon>
          <mat-error>{{ getFieldError('phone') }}</mat-error>
        </mat-form-field>

        <!-- Address -->
        <mat-form-field appearance="outline">
          <mat-label>Dirección</mat-label>
          <input 
            matInput 
            formControlName="address" 
            placeholder="Dirección completa">
          <mat-icon matPrefix>location_on</mat-icon>
          <mat-error>{{ getFieldError('address') }}</mat-error>
        </mat-form-field>
      </div>
    </div>

    <!-- System Information -->
    <div class="section mb-6">
      <h3 class="section-title">Configuración del Sistema</h3>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- Role -->
        <mat-form-field appearance="outline">
          <mat-label>Rol del Usuario *</mat-label>
          <mat-select formControlName="role">
            <mat-option *ngFor="let role of roles" [value]="role.value">
              <div class="role-option">
                <div class="flex items-center">
                  <mat-icon 
                    [style.color]="getRoleColor(role.value)"
                    class="mr-2">
                    {{ getRoleIcon(role.value) }}
                  </mat-icon>
                  <div>
                    <div class="font-medium">{{ role.label }}</div>
                    <div class="text-xs text-gray-500">{{ role.description }}</div>
                  </div>
                </div>
              </div>
            </mat-option>
          </mat-select>
          <mat-error>{{ getFieldError('role') }}</mat-error>
        </mat-form-field>

        <!-- Status -->
        <div class="status-field">
          <label class="block text-sm font-medium text-gray-700 mb-2">Estado del Usuario</label>
          <mat-slide-toggle 
            formControlName="isActive" 
            color="primary">
            <span [class.text-green-600]="userForm.get('isActive')?.value" 
                  [class.text-red-600]="!userForm.get('isActive')?.value">
              {{ userForm.get('isActive')?.value ? 'Activo' : 'Inactivo' }}
            </span>
          </mat-slide-toggle>
          <mat-hint class="text-xs text-gray-500 mt-1">
            Los usuarios inactivos no pueden acceder al sistema
          </mat-hint>
        </div>
      </div>
    </div>

    <!-- Additional Information -->
    <div class="section">
      <h3 class="section-title">Información Adicional</h3>
      
      <!-- Bio -->
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Biografía</mat-label>
        <textarea 
          matInput 
          formControlName="bio" 
          rows="3"
          placeholder="Información adicional sobre el usuario..."></textarea>
        <mat-icon matPrefix>description</mat-icon>
        <mat-hint align="end">
          {{ (userForm.get('bio')?.value || '').length }}/500
        </mat-hint>
        <mat-error>{{ getFieldError('bio') }}</mat-error>
      </mat-form-field>
    </div>

    <!-- Form Summary for Edit Mode -->
    <div *ngIf="isEditMode && data.user" class="summary-section mt-6 p-4 bg-blue-50 rounded-lg">
      <h4 class="font-medium text-blue-900 mb-2">Información del Usuario</h4>
      <div class="text-sm text-blue-700 space-y-1">
        <p><strong>Creado:</strong> {{ data.user.createdAt | date:'medium' }}</p>
        <p *ngIf="data.user.lastLoginAt">
          <strong>Último acceso:</strong> {{ data.user.lastLoginAt | date:'medium' }}
        </p>
        <p><strong>ID:</strong> {{ data.user.id }}</p>
      </div>
    </div>
  </div>

  <!-- Dialog Actions -->
  <div mat-dialog-actions class="dialog-actions">
    <button 
      mat-button 
      type="button" 
      (click)="onCancel()"
      [disabled]="isLoading">
      Cancelar
    </button>
    <button 
      mat-raised-button 
      color="primary" 
      type="submit"
      [disabled]="userForm.invalid || isLoading">
      <mat-icon *ngIf="isLoading">hourglass_empty</mat-icon>
      <mat-icon *ngIf="!isLoading">{{ isEditMode ? 'save' : 'person_add' }}</mat-icon>
      {{ isEditMode ? 'Actualizar' : 'Crear Usuario' }}
    </button>
  </div>
</form>