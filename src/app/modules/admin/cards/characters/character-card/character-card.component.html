<!-- Character Card -->
<div class="character-card group relative bg-white dark:bg-gray-800 rounded-2xl shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden cursor-pointer border border-gray-200 dark:border-gray-700 hover:border-primary-300 dark:hover:border-primary-600"
     [class.compact]="compact"
     (click)="onCardClick($event)">
     
    <!-- Character Image -->
    <div class="relative h-48 md:h-56 overflow-hidden bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800"
         [class.h-32]="compact">
        <img
            [src]="getAvatarUrl()"
            [alt]="character.nombre"
            class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"
            loading="lazy"
            (error)="$event.target.src = getDefaultAvatarUrl()">
        
        <!-- Type Badge -->
        <div class="absolute top-3 left-3 flex items-center space-x-1 bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm px-2 py-1 rounded-full text-xs font-medium">
            <mat-icon class="text-sm !w-4 !h-4" [class]="'text-' + character.tipo">{{ getTypeIcon() }}</mat-icon>
            <span class="text-gray-700 dark:text-gray-300">{{ getTypeLabel() }}</span>
        </div>

        <!-- Context Badge -->
        <div class="absolute top-3 right-3 flex items-center space-x-1 bg-primary-100 dark:bg-primary-900 px-2 py-1 rounded-full text-xs">
            <mat-icon class="text-sm !w-4 !h-4 text-primary-600 dark:text-primary-400">{{ getContextIcon() }}</mat-icon>
            <span class="text-primary-700 dark:text-primary-300">{{ getContextLabel() }}</span>
        </div>

        <!-- Favorite Button -->
        <button 
            mat-icon-button
            class="!absolute bottom-3 right-3 !bg-white/80 dark:!bg-gray-800/80 backdrop-blur-sm hover:!bg-white dark:hover:!bg-gray-700 transition-all duration-200"
            [class.!text-red-500]="isFavorite()"
            (click)="onToggleFavorite($event)"
            matTooltip="Agregar a favoritos">
            <mat-icon>{{ isFavorite() ? 'favorite' : 'favorite_border' }}</mat-icon>
        </button>

        <!-- Status Indicator -->
        <div class="absolute bottom-3 left-3">
            <div class="flex items-center space-x-1 bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm px-2 py-1 rounded-full text-xs">
                <div class="w-2 h-2 rounded-full" 
                     [class.bg-green-500]="character.activo"
                     [class.bg-gray-400]="!character.activo"></div>
                <span class="text-gray-700 dark:text-gray-300">
                    {{ character.activo ? 'Activo' : 'Inactivo' }}
                </span>
            </div>
        </div>
    </div>

    <!-- Card Content -->
    <div class="p-4 space-y-3" [class.p-3]="compact" [class.space-y-2]="compact">
        <!-- Character Name and Level -->
        <div class="flex items-start justify-between">
            <div class="flex-1 min-w-0">
                <h3 class="font-bold text-lg text-gray-900 dark:text-white truncate group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors">
                    {{ character.nombre }}
                </h3>
                <div class="flex items-center space-x-2 text-sm text-gray-500 dark:text-gray-400 mt-1">
                    <span>Nivel {{ character.estadisticas.nivel }}</span>
                    <span>•</span>
                    <span>{{ getCharacterAge() ? getCharacterAge() + ' años' : getObjectCategory() }}</span>
                </div>
            </div>
            <div class="ml-2 flex items-center">
                <div class="text-right">
                    <div class="text-sm font-medium text-gray-900 dark:text-white">
                        {{ character.metadatos.valoracion_promedio.toFixed(1) }}
                    </div>
                    <div class="flex items-center space-x-0.5 mt-0.5">
                        <mat-icon 
                            *ngFor="let star of getRatingStars(); trackBy: trackByStar"
                            class="text-xs !w-3 !h-3"
                            [class.text-yellow-400]="star === 1"
                            [class.text-yellow-300]="star === 0.5"
                            [class.text-gray-300]="star === 0">
                            {{ star === 0.5 ? 'star_half' : 'star' }}
                        </mat-icon>
                    </div>
                </div>
            </div>
        </div>

        <!-- Description -->
        <p class="text-sm text-gray-600 dark:text-gray-300 line-clamp-2" 
           [class.line-clamp-1]="compact">
            {{ getTruncatedDescription(compact ? 80 : 120) }}
        </p>

        <!-- Character Details -->
        <div class="space-y-2" *ngIf="!compact">
            <!-- Personality traits for personas -->
            <div *ngIf="character.tipo === 'persona' && character.atributos_persona?.personalidad.length" 
                 class="flex flex-wrap gap-1">
                <span *ngFor="let trait of character.atributos_persona.personalidad.slice(0, 3)" 
                      class="inline-block bg-blue-100 dark:bg-blue-900 text-blue-800 dark:text-blue-200 text-xs px-2 py-1 rounded-full">
                    {{ trait }}
                </span>
                <span *ngIf="character.atributos_persona.personalidad.length > 3"
                      class="inline-block bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 text-xs px-2 py-1 rounded-full">
                    +{{ character.atributos_persona.personalidad.length - 3 }} más
                </span>
            </div>

            <!-- Functionality for objects -->
            <div *ngIf="character.tipo === 'objeto' && character.atributos_objeto?.funcionalidad.length" 
                 class="flex flex-wrap gap-1">
                <span *ngFor="let func of character.atributos_objeto.funcionalidad.slice(0, 3)" 
                      class="inline-block bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs px-2 py-1 rounded-full">
                    {{ func }}
                </span>
                <span *ngIf="character.atributos_objeto.funcionalidad.length > 3"
                      class="inline-block bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 text-xs px-2 py-1 rounded-full">
                    +{{ character.atributos_objeto.funcionalidad.length - 3 }} más
                </span>
            </div>
        </div>

        <!-- Stats Section -->
        <div *ngIf="showStats && !compact" class="stats-section">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <!-- Dominant Stat -->
                    <div class="flex items-center space-x-2">
                        <mat-icon class="text-sm !w-4 !h-4 text-primary-600 dark:text-primary-400">
                            {{ getDominantStat().icon }}
                        </mat-icon>
                        <div class="text-xs">
                            <span class="font-medium text-gray-900 dark:text-white">{{ getDominantStat().value }}</span>
                            <span class="text-gray-500 dark:text-gray-400 ml-1">{{ getDominantStat().name }}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Usage Stats -->
                <div class="flex items-center space-x-3 text-xs text-gray-500 dark:text-gray-400">
                    <div class="flex items-center space-x-1">
                        <mat-icon class="!w-3 !h-3">visibility</mat-icon>
                        <span>{{ character.metadatos.usos_totales }}</span>
                    </div>
                    <div class="flex items-center space-x-1">
                        <mat-icon class="!w-3 !h-3">thumb_up</mat-icon>
                        <span>{{ character.metadatos.popularidad }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div *ngIf="showActions" 
             class="character-actions flex items-center justify-between pt-3 mt-3 border-t border-gray-100 dark:border-gray-700">
            <div class="flex items-center space-x-2">
                <button
                    mat-button
                    color="primary"
                    class="!text-sm"
                    (click)="onViewDetails($event)">
                    <mat-icon class="mr-1 !w-4 !h-4">visibility</mat-icon>
                    Ver Detalles
                </button>
            </div>
            
            <div class="flex items-center space-x-1">
                <button
                    mat-icon-button
                    class="!w-8 !h-8"
                    matTooltip="Editar"
                    (click)="onEditCharacter($event)">
                    <mat-icon class="!w-4 !h-4">edit</mat-icon>
                </button>
                
                <button
                    mat-icon-button
                    color="warn"
                    class="!w-8 !h-8"
                    matTooltip="Eliminar"
                    (click)="onDeleteCharacter($event)">
                    <mat-icon class="!w-4 !h-4">delete</mat-icon>
                </button>
            </div>
        </div>

        <!-- Last Updated -->
        <div class="text-xs text-gray-400 dark:text-gray-500 text-right" *ngIf="!compact">
            Actualizado {{ getFormattedLastUpdate() }}
        </div>
    </div>

    <!-- Hover Overlay -->
    <div class="absolute inset-0 bg-primary-500/5 opacity-0 group-hover:opacity-100 transition-opacity duration-300 pointer-events-none"></div>
</div>