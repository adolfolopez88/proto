<!-- Filters Section -->
<div class="bg-white dark:bg-gray-900 border-b">
    <!-- Search Bar - Always visible -->
    <div class="p-4 sm:p-6">
        <mat-form-field class="w-full" appearance="outline">
            <mat-label>üîç Buscar prompts...</mat-label>
            <input matInput [formControl]="searchControl" 
                   placeholder="T√≠tulo, descripci√≥n, contenido o tags"
                   autocomplete="off">
            <mat-icon matSuffix svgIcon="heroicons_outline:search"></mat-icon>
        </mat-form-field>
    </div>

    <!-- Collapsible Filters -->
    <mat-expansion-panel class="mat-elevation-0 border-0">
        <mat-expansion-panel-header class="px-4 sm:px-6 py-2">
            <mat-panel-title class="text-sm font-medium">
                <mat-icon class="mr-2" svgIcon="heroicons_outline:adjustments"></mat-icon>
                Filtros avanzados
            </mat-panel-title>
            <mat-panel-description class="text-xs">
                Categor√≠a, idioma, estado
            </mat-panel-description>
        </mat-expansion-panel-header>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 p-4 sm:p-6 pt-0">
            <!-- Category Filter -->
            <mat-form-field appearance="outline">
                <mat-label>Categor√≠a</mat-label>
                <mat-select [formControl]="categoryFilter">
                    <mat-option *ngFor="let category of categories" [value]="category.id">
                        {{category.name}}
                    </mat-option>
                </mat-select>
                <mat-icon matSuffix svgIcon="heroicons_outline:tag"></mat-icon>
            </mat-form-field>

            <!-- Language Filter -->
            <mat-form-field appearance="outline">
                <mat-label>Idioma</mat-label>
                <mat-select [formControl]="languageFilter">
                    <mat-option value="all">Todos</mat-option>
                    <mat-option *ngFor="let language of languages" [value]="language">
                        {{language}}
                    </mat-option>
                </mat-select>
                <mat-icon matSuffix svgIcon="heroicons_outline:globe-alt"></mat-icon>
            </mat-form-field>

            <!-- Status Filter -->
            <mat-form-field appearance="outline">
                <mat-label>Estado</mat-label>
                <mat-select [formControl]="statusFilter">
                    <mat-option *ngFor="let status of statusOptions" [value]="status.value">
                        {{status.label}}
                    </mat-option>
                </mat-select>
                <mat-icon matSuffix svgIcon="heroicons_outline:eye"></mat-icon>
            </mat-form-field>

            <!-- Clear Filters -->
            <div class="flex items-end">
                <button mat-stroked-button class="w-full h-14" (click)="clearFilters()">
                    <mat-icon svgIcon="heroicons_outline:x"></mat-icon>
                    <span class="ml-2">Limpiar</span>
                </button>
            </div>
        </div>
    </mat-expansion-panel>
    
    <!-- Results Summary -->
    <div class="px-4 sm:px-6 py-3 bg-gray-50 dark:bg-gray-800 border-t">
        <div class="flex items-center justify-between text-sm">
            <span class="text-gray-600 dark:text-gray-300">
                {{dataSource.data.length}} prompts encontrados
            </span>
            <div class="flex items-center gap-4">
                <!-- View Toggle -->
                <div class="hidden sm:flex items-center gap-1">
                    <button mat-icon-button 
                            [class.text-primary-600]="viewMode === 'table'"
                            (click)="setViewMode('table')"
                            matTooltip="Vista tabla">
                        <mat-icon svgIcon="heroicons_outline:view-list"></mat-icon>
                    </button>
                    <button mat-icon-button 
                            [class.text-primary-600]="viewMode === 'grid'"
                            (click)="setViewMode('grid')"
                            matTooltip="Vista tarjetas">
                        <mat-icon svgIcon="heroicons_outline:view-grid"></mat-icon>
                    </button>
                </div>
                <!-- Create Prompt Button -->
                <button mat-mini-fab 
                        color="primary" 
                        (click)="createPrompt()"
                        matTooltip="Crear nuevo prompt"
                        class="sm:hidden">
                    <mat-icon svgIcon="heroicons_outline:plus"></mat-icon>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Loading -->
<div *ngIf="loading" class="flex items-center justify-center p-8">
    <mat-spinner diameter="40"></mat-spinner>
</div>

<!-- Grid View - Mobile Friendly Cards -->
<div *ngIf="!loading && viewMode === 'grid'" class="p-4 sm:p-6">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-6">
        <mat-card *ngFor="let prompt of dataSource.data" 
                  class="prompt-card cursor-pointer transition-all duration-200 hover:shadow-lg"
                  (click)="viewPrompt(prompt)">
            
            <!-- Card Header -->
            <mat-card-header class="pb-2">
                <div mat-card-avatar class="flex items-center justify-center text-white text-sm font-bold rounded-full w-10 h-10"
                     [style.background-color]="prompt.category?.color || '#6366f1'">
                    {{prompt.category?.name?.charAt(0) || 'P'}}
                </div>
                <mat-card-title class="text-base font-semibold line-clamp-2">
                    {{prompt.title}}
                </mat-card-title>
                <mat-card-subtitle class="text-sm">
                    {{prompt.author}}
                </mat-card-subtitle>
            </mat-card-header>

            <!-- Card Content -->
            <mat-card-content class="py-3">
                <p class="text-sm text-gray-600 dark:text-gray-300 line-clamp-3 mb-3">
                    {{prompt.description || 'Sin descripci√≥n'}}
                </p>
                
                <!-- Tags -->
                <div class="flex flex-wrap gap-1 mb-3" *ngIf="prompt.tags?.length">
                    <span *ngFor="let tag of prompt.tags.slice(0, 3)" 
                          class="inline-flex px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full dark:bg-blue-800 dark:text-blue-100">
                        {{tag}}
                    </span>
                    <span *ngIf="prompt.tags.length > 3" 
                          class="inline-flex px-2 py-1 text-xs font-medium bg-gray-100 text-gray-600 rounded-full dark:bg-gray-700 dark:text-gray-300">
                        +{{prompt.tags.length - 3}}
                    </span>
                </div>

                <!-- Stats Row -->
                <div class="flex items-center justify-between text-xs text-gray-500">
                    <div class="flex items-center gap-3">
                        <!-- Rating -->
                        <div class="flex items-center">
                            <mat-icon class="w-4 h-4 text-yellow-400">star</mat-icon>
                            <span class="ml-1">{{prompt.rating || 0}}</span>
                        </div>
                        <!-- Usage -->
                        <div class="flex items-center">
                            <mat-icon class="w-4 h-4">visibility</mat-icon>
                            <span class="ml-1">{{prompt.usageCount || 0}}</span>
                        </div>
                    </div>
                    <!-- Language -->
                    <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded dark:bg-gray-700 dark:text-gray-300">
                        {{prompt.language}}
                    </span>
                </div>
            </mat-card-content>

            <!-- Card Actions -->
            <mat-card-actions class="flex justify-between items-center">
                <!-- Status Badges -->
                <div class="flex gap-1">
                    <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full"
                          [class.bg-green-100]="prompt.isActive"
                          [class.text-green-800]="prompt.isActive"
                          [class.bg-red-100]="!prompt.isActive"
                          [class.text-red-800]="!prompt.isActive">
                        {{prompt.isActive ? 'Activo' : 'Inactivo'}}
                    </span>
                    <span *ngIf="prompt.isPublic" 
                          class="inline-flex px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">
                        P√∫blico
                    </span>
                </div>

                <!-- Quick Actions -->
                <div class="flex gap-1">
                    <button mat-icon-button 
                            (click)="editPrompt(prompt); $event.stopPropagation()"
                            matTooltip="Editar">
                        <mat-icon class="w-4 h-4" svgIcon="heroicons_outline:pencil"></mat-icon>
                    </button>
                    <button mat-icon-button 
                            [matMenuTriggerFor]="cardActionsMenu"
                            (click)="$event.stopPropagation()">
                        <mat-icon class="w-4 h-4" svgIcon="heroicons_outline:dots-vertical"></mat-icon>
                    </button>
                    
                    <mat-menu #cardActionsMenu="matMenu">
                        <button mat-menu-item (click)="clonePrompt(prompt)">
                            <mat-icon svgIcon="heroicons_outline:duplicate"></mat-icon>
                            <span>Clonar</span>
                        </button>
                        <button mat-menu-item (click)="togglePromptStatus(prompt)">
                            <mat-icon [svgIcon]="prompt.isActive ? 'heroicons_outline:eye-off' : 'heroicons_outline:eye'"></mat-icon>
                            <span>{{prompt.isActive ? 'Desactivar' : 'Activar'}}</span>
                        </button>
                        <mat-divider></mat-divider>
                        <button mat-menu-item (click)="deletePrompt(prompt)" class="text-red-600">
                            <mat-icon svgIcon="heroicons_outline:trash"></mat-icon>
                            <span>Eliminar</span>
                        </button>
                    </mat-menu>
                </div>
            </mat-card-actions>
        </mat-card>
    </div>

    <!-- Empty state for grid -->
    <div *ngIf="dataSource.data.length === 0" class="flex flex-col items-center justify-center py-12">
        <mat-icon class="w-16 h-16 text-gray-400 mb-4" svgIcon="heroicons_outline:document-text"></mat-icon>
        <div class="text-xl font-medium text-gray-900 dark:text-gray-100 mb-2">
            No se encontraron prompts
        </div>
        <div class="text-gray-500 dark:text-gray-400 mb-6 text-center">
            Crea tu primer prompt para comenzar a organizar tus ideas
        </div>
        <button mat-flat-button [color]="'primary'" (click)="createPrompt()">
            <mat-icon svgIcon="heroicons_outline:plus"></mat-icon>
            <span class="ml-2">Crear Primer Prompt</span>
        </button>
    </div>

    <!-- Pagination for grid -->
    <mat-paginator 
        *ngIf="dataSource.data.length > 0"
        [pageSizeOptions]="[12, 24, 48, 96]"
        [pageSize]="24"
        showFirstLastButtons>
    </mat-paginator>
</div>

<!-- Table View -->
<div *ngIf="!loading && viewMode === 'table'" class="overflow-auto">
    <table mat-table [dataSource]="dataSource" matSort class="w-full">
        
        <!-- Title Column -->
        <ng-container matColumnDef="title">
            <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold">T√≠tulo</th>
            <td mat-cell *matCellDef="let prompt" class="max-w-xs">
                <div class="font-medium text-sm truncate">{{prompt.title}}</div>
                <div class="text-xs text-gray-500 truncate" *ngIf="prompt.description">
                    {{prompt.description}}
                </div>
                <div class="flex flex-wrap gap-1 mt-1" *ngIf="prompt.tags?.length">
                    <span *ngFor="let tag of prompt.tags.slice(0, 2)" 
                          class="inline-flex px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full dark:bg-blue-800 dark:text-blue-100">
                        {{tag}}
                    </span>
                    <span *ngIf="prompt.tags.length > 2" 
                          class="inline-flex px-2 py-1 text-xs font-medium bg-gray-100 text-gray-600 rounded-full dark:bg-gray-700 dark:text-gray-300">
                        +{{prompt.tags.length - 2}}
                    </span>
                </div>
            </td>
        </ng-container>

        <!-- Category Column -->
        <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef class="font-semibold">Categor√≠a</th>
            <td mat-cell *matCellDef="let prompt">
                <span *ngIf="prompt.category" 
                      class="inline-flex px-2 py-1 text-xs font-medium rounded-full"
                      [style.background-color]="prompt.category.color + '20'"
                      [style.color]="prompt.category.color">
                    <mat-icon [svgIcon]="prompt.category.icon" class="w-3 h-3 mr-1"></mat-icon>
                    {{prompt.category.name}}
                </span>
            </td>
        </ng-container>

        <!-- Language Column -->
        <ng-container matColumnDef="language">
            <th mat-header-cell *matHeaderCellDef class="font-semibold">Idioma</th>
            <td mat-cell *matCellDef="let prompt">
                <span class="text-sm">{{prompt.language}}</span>
            </td>
        </ng-container>

        <!-- Rating Column -->
        <ng-container matColumnDef="rating">
            <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold">Rating</th>
            <td mat-cell *matCellDef="let prompt">
                <div class="flex items-center">
                    <div class="flex">
                        <mat-icon *ngFor="let star of getRatingStars(prompt.rating)" 
                                  class="w-4 h-4 text-yellow-400">
                            {{star}}
                        </mat-icon>
                    </div>
                    <span class="ml-1 text-xs text-gray-500">
                        ({{prompt.totalRatings}})
                    </span>
                </div>
            </td>
        </ng-container>

        <!-- Usage Count Column -->
        <ng-container matColumnDef="usageCount">
            <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold">Usos</th>
            <td mat-cell *matCellDef="let prompt">
                <span class="inline-flex px-2 py-1 text-xs font-medium bg-gray-100 text-gray-800 rounded-full dark:bg-gray-700 dark:text-gray-200">
                    {{prompt.usageCount}}
                </span>
            </td>
        </ng-container>

        <!-- Public Status Column -->
        <ng-container matColumnDef="isPublic">
            <th mat-header-cell *matHeaderCellDef class="font-semibold">P√∫blico</th>
            <td mat-cell *matCellDef="let prompt">
                <mat-icon class="w-5 h-5" [class.text-green-500]="prompt.isPublic" [class.text-gray-400]="!prompt.isPublic">
                    {{prompt.isPublic ? 'check_circle' : 'radio_button_unchecked'}}
                </mat-icon>
            </td>
        </ng-container>

        <!-- Active Status Column -->
        <ng-container matColumnDef="isActive">
            <th mat-header-cell *matHeaderCellDef class="font-semibold">Activo</th>
            <td mat-cell *matCellDef="let prompt">
                <mat-slide-toggle 
                    [checked]="prompt.isActive"
                    (change)="togglePromptStatus(prompt)"
                    [color]="'primary'">
                </mat-slide-toggle>
            </td>
        </ng-container>

        <!-- Updated Date Column -->
        <ng-container matColumnDef="updatedAt">
            <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-semibold">Actualizado</th>
            <td mat-cell *matCellDef="let prompt">
                <span class="text-sm text-gray-500">
                    {{prompt.updatedAt | date:'short'}}
                </span>
            </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="font-semibold">Acciones</th>
            <td mat-cell *matCellDef="let prompt" class="w-32">
                <div class="flex items-center gap-1">
                    <!-- View -->
                    <button mat-icon-button 
                            (click)="viewPrompt(prompt)"
                            matTooltip="Ver detalle">
                        <mat-icon svgIcon="heroicons_outline:eye"></mat-icon>
                    </button>
                    
                    <!-- Edit -->
                    <button mat-icon-button 
                            (click)="editPrompt(prompt)"
                            matTooltip="Editar">
                        <mat-icon svgIcon="heroicons_outline:pencil"></mat-icon>
                    </button>
                    
                    <!-- More actions -->
                    <button mat-icon-button [matMenuTriggerFor]="actionsMenu">
                        <mat-icon svgIcon="heroicons_outline:dots-vertical"></mat-icon>
                    </button>
                    
                    <mat-menu #actionsMenu="matMenu">
                        <button mat-menu-item (click)="clonePrompt(prompt)">
                            <mat-icon svgIcon="heroicons_outline:duplicate"></mat-icon>
                            <span>Clonar</span>
                        </button>
                        <mat-divider></mat-divider>
                        <button mat-menu-item (click)="deletePrompt(prompt)" class="text-red-600">
                            <mat-icon svgIcon="heroicons_outline:trash"></mat-icon>
                            <span>Eliminar</span>
                        </button>
                    </mat-menu>
                </div>
            </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
            class="hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer"
            (click)="viewPrompt(row)"></tr>
    </table>

    <!-- No data -->
    <div *ngIf="dataSource.data.length === 0" class="flex flex-col items-center justify-center py-12">
        <mat-icon class="w-12 h-12 text-gray-400 mb-4" svgIcon="heroicons_outline:document-text"></mat-icon>
        <div class="text-xl font-medium text-gray-900 dark:text-gray-100 mb-2">
            No se encontraron prompts
        </div>
        <div class="text-gray-500 dark:text-gray-400 mb-6">
            Crea tu primer prompt para comenzar
        </div>
        <button mat-flat-button [color]="'primary'" (click)="createPrompt()">
            <mat-icon svgIcon="heroicons_outline:plus"></mat-icon>
            <span class="ml-2">Crear Prompt</span>
        </button>
    </div>

    <!-- Paginator -->
    <mat-paginator 
        [pageSizeOptions]="[10, 25, 50, 100]"
        [pageSize]="25"
        showFirstLastButtons
        *ngIf="dataSource.data.length > 0">
    </mat-paginator>
</div>